include(ExternalProject)

if (CMAKE_SIZEOF_VOID_P EQUAL 8)
  set(ASSIMP_ARCHITECTURE "x64")
elseif (CMAKE_SIZEOF_VOID_P EQUAL 4)
  set(ASSIMP_ARCHITECTURE "")
endif (CMAKE_SIZEOF_VOID_P EQUAL 8)

SET(PREFIX Assimp)
SET(GIT_URL https://github.com/assimp/assimp.git)
SET(GIT_TAG v4.1.0)

SET(ASSIMP_VERSION "4.1.0")

SET(ASSIMP_INSTALL_DIR ${CMAKE_BINARY_DIR}/externals/ CACHE PATH "" FORCE)

ExternalProject_Add(${PREFIX}
  GIT_REPOSITORY "${GIT_URL}"
  GIT_TAG "${GIT_TAG}"
  PREFIX "${CMAKE_CURRENT_BINARY_DIR}"
  UPDATE_COMMAND ""
  PATCH_COMMAND ""
  CMAKE_ARGS ${CL_ARGS}
  -DASSIMP_BUILD_TESTS=OFF
  -DASSIMP_BUILD_ASSIMP_TOOLS=OFF
  -DCMAKE_INSTALL_PREFIX=${ASSIMP_INSTALL_DIR}
#  -DCMAKE_DEBUG_POSTFIX=${CMAKE_DEBUG_POSTFIX}
  TEST_COMMAND ""
  )

if (WIN32)
  if (NOT GENERATOR_IS_MULTI_CONFIG)
    incude(kurva_anyad)
  endif ()

  set(_lib_dir "/lib/")
  set(_bin_dir "/bin/")
  # MSVC only
  if (MSVC12)
    set(ASSIMP_MSVC_VERSION "vc120")
  elseif (MSVC14)
    set(ASSIMP_MSVC_VERSION "vc140")
  endif (MSVC12)
  SET(ASSIMP_LIBRARY_RELEASE assimp-${ASSIMP_MSVC_VERSION}-mt${CMAKE_RELEASE_POSTFIX}.lib CACHE STRING "")
  SET(ASSIMP_LIBRARY_DEBUG assimp-${ASSIMP_MSVC_VERSION}-mt${CMAKE_DEBUG_POSTFIX}.lib CACHE STRING "")
  SET(ASSIMP_BINARY_RELEASE assimp-${ASSIMP_MSVC_VERSION}-mt${CMAKE_RELEASE_POSTFIX}.dll CACHE STRING "")
  SET(ASSIMP_BINARY_DEBUG assimp-${ASSIMP_MSVC_VERSION}-mt${CMAKE_DEBUG_POSTFIX}.dll CACHE STRING "")

elseif (UNIX AND NOT APPLE)
  set(_lib_dir "/lib/")
  set(_bin_dir "/lib/")
  if (GENERATOR_IS_MULTI_CONFIG)
    SET(ASSIMP_LIBRARY_RELEASE assimp${CMAKE_RELEASE_POSTFIX}.${ASSIMP_VERSION} CACHE STRING "")
    SET(ASSIMP_LIBRARY_DEBUG assimp${CMAKE_DEBUG_POSTFIX}.${ASSIMP_VERSION} CACHE STRING "")
    SET(ASSIMP_BINARY_RELEASE libassimp${CMAKE_RELEASE_POSTFIX}.so.${ASSIMP_VERSION} CACHE STRING "")
    SET(ASSIMP_BINARY_DEBUG libassimp${CMAKE_DEBUG_POSTFIX}.so.${ASSIMP_VERSION} CACHE STRING "")
  else ()
    SET(ASSIMP_LIBRARY assimp.${ASSIMP_VERSION} CACHE STRING "")
    SET(ASSIMP_BINARY libassimp.${ASSIMP_VERSION}.so CACHE STRING "")
  endif ()

elseif (APPLE)
  set(_lib_dir "/lib/")
  set(_bin_dir "/lib/")

  if (GENERATOR_IS_MULTI_CONFIG)
    SET(ASSIMP_LIBRARY_RELEASE assimp${CMAKE_RELEASE_POSTFIX}.${ASSIMP_VERSION} CACHE STRING "")
    SET(ASSIMP_LIBRARY_DEBUG assimp${CMAKE_DEBUG_POSTFIX}.${ASSIMP_VERSION} CACHE STRING "")
    SET(ASSIMP_BINARY_RELEASE libassimp${CMAKE_RELEASE_POSTFIX}.${ASSIMP_VERSION}.dylib CACHE STRING "")
    SET(ASSIMP_BINARY_DEBUG libassimp${CMAKE_DEBUG_POSTFIX}.${ASSIMP_VERSION}.dylib CACHE STRING "")
  else ()
    SET(ASSIMP_LIBRARY assimp.${ASSIMP_VERSION} CACHE STRING "")
    SET(ASSIMP_BINARY libassimp.${ASSIMP_VERSION}.dylib CACHE STRING "")
  endif ()
endif ()

# glue together

SET(ASSIMP_BINARY_DIR ${ASSIMP_INSTALL_DIR}/bin CACHE PATH "")
SET(ASSIMP_LIBRARY_DIR ${ASSIMP_INSTALL_DIR}/lib CACHE PATH "")
SET(ASSIMP_INCLUDE_DIR ${ASSIMP_INSTALL_DIR}/include CACHE PATH "")

if (GENERATOR_IS_MULTI_CONFIG)
  set(ASSIMP_LIBRARY
    # ${ASSIMP_LIBRARY_RELEASE}
    # For some reason, it sucks
    optimized ${ASSIMP_LIBRARY_RELEASE}
    debug ${ASSIMP_LIBRARY_DEBUG}
    CACHE INTERNAL "" FORCE
    )

  SET(ASSIMP_BINARIES_RELEASE
    ${ASSIMP_BINARY_DIR}/${ASSIMP_BINARY_RELEASE}
    CACHE INTERNAL "" FORCE)

  SET(ASSIMP_BINARIES_DEBUG
    ${ASSIMP_BINARY_DIR}/${ASSIMP_BINARY_DEBUG}
    CACHE INTERNAL "" FORCE)
endif ()

if (WIN32)
  install(FILES ${ASSIMP_BINARIES} DESTINATION "bin")
  install(FILES ${ASSIMP_LIBRARY_DIR}/${ASSIMP_LIBRARY_RELEASE} DESTINATION "lib")
  install(FILES ${ASSIMP_LIBRARY_DIR}/${ASSIMP_LIBRARY_DEBUG} DESTINATION "lib")
endif (WIN32)
